<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="TmsProgrmManage">

	<typeAlias  alias="comDefaultVO" type="egovframework.com.cmm.ComDefaultVO"/>
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="TmsProgrmManageVO" type="egovframework.let.sym.prm.service.TmsProgrmManageVO"/>
	<typeAlias  alias="TmsProjectManageVO" type="egovframework.let.sym.prm.service.TmsProjectManageVO"/>
	<typeAlias  alias="TmsCommonManageVO" type="egovframework.let.sym.prm.service.TmsCommonManageVO"/>
	<typeAlias  alias="TmsLoginVO" type="egovframework.com.cmm.TmsLoginVO"/>
	<typeAlias  alias="CommonCodeVO" type="egovframework.com.cmm.CommonCodeVO"/>

    <!-- 프로그램목록 관리 -->
	<resultMap id="TmsProgrmManage"       class="egovframework.let.sym.prm.service.TmsProgrmManageVO">
		<result property="PG_ID"    column="PG_ID"    columnIndex="1"/>
		<result property="USER_DEV_ID"  column="USER_DEV_ID"  columnIndex="2"/>
		<result property="PG_NM"  column="PG_NM"  columnIndex="3"/>
		<result property="SYS_GB"        column="SYS_GB"        columnIndex="4"/>
		<result property="TASK_GB"             column="TASK_GB"             columnIndex="5"/>
		<result property="USE_YN"             column="USE_YN"             columnIndex="6"/>
		<result property="PJT_ID"             column="PJT_ID"             columnIndex="7"/>
		<result property="USER_REAL_ID"             column="USER_REAL_ID"             columnIndex="8"/>
	</resultMap> 
	
	<select id="TmsProgrmManageDAO.selectProgrmList_D" parameterClass="comDefaultVO" resultMap="TmsProgrmManage">
		<![CDATA[
			SELECT 
				  PG_ID   AS "PG_ID"
				, (SELECT USER_NM FROM LETTNEMPLYRINFO WHERE EMPLYR_ID = USER_DEV_ID) AS "USER_DEV_ID"
				, USER_DEV_ID AS "USER_REAL_ID"
				, PG_NM  AS "PG_NM" 
				, (SELECT CODE_NM FROM LETTCCMMNDETAILCODE WHERE CODE = SYS_GB) AS "SYS_GB" 
				, (SELECT CODE_NM FROM LETTCCMMNDETAILCODE WHERE CODE = TASK_GB) AS "TASK_GB"
				, USE_YN              AS "USE_YN"
				, PJT_ID              AS "PJT_ID"
			FROM LETTCCMMNDETAILCODE, PG_TB
			WHERE binary(PG_NM) like  CONCAT('%', #searchKeyword#, '%') AND SYS_GB = CODE
			LIMIT  #recordCountPerPage# OFFSET #firstIndex#
		 ]]>
	</select> 

	<!-- 총건수 조회 -->
	<select id="TmsProgrmManageDAO.selectProgrmListTotCnt_S" parameterClass="comDefaultVO" resultClass="int">
		<![CDATA[
		SELECT COUNT(*) AS totcnt
		  FROM LETTCCMMNDETAILCODE A, PG_TB B
		 WHERE binary(PG_NM) like  CONCAT('%', #searchKeyword#, '%') AND SYS_GB = CODE
		]]>
	</select>
	<!-- 프로그램 정보 조회 -->
	<select id="TmsProgrmManageDAO.selectProject" resultClass="TmsProjectManageVO">
		<![CDATA[
			SELECT 
				  PJT_ID,
				  PJT_NM,
				  PJT_TYPE,
				  PJT_ST,
				  PJT_PM,
				  PJT_PRICE,
				  DEV_START_DT,
				  DEV_END_DT,
				  PJT_START_DT,
				  PJT_END_DT,
				  PJT_CONTENT
			FROM PJT_TB
		 ]]>
	</select>
	
	<!-- 시스템구분 조회 -->
	<select id="TmsProgrmManageDAO.selectSysGb" resultClass="TmsProgrmManageVO">
			SELECT CODE_NM AS "SYS_GB" FROM LETTCCMMNDETAILCODE WHERE CODE_ID = 'SYSGB'
	</select>
	
	<!-- 업무구분 조회 -->
	<select id="TmsProgrmManageDAO.selectTaskGb" resultClass="TmsProgrmManageVO">
			SELECT CODE_NM AS "TASK_GB" FROM LETTCCMMNDETAILCODE WHERE CODE_ID = 'TASKGB'
	</select>  
	
	<!-- 업무구분 조회 -->
	<select id="TmsProgrmManageDAO.selectTaskGbSearch" resultClass="TmsProgrmManageVO">
		SELECT CODE_NM AS "TASK_GB"
		FROM LETTCCMMNDETAILCODE
		WHERE PARENT = (SELECT CODE
		FROM LETTCCMMNDETAILCODE
		WHERE CODE_NM = (SELECT CODE_NM  FROM LETTCCMMNDETAILCODE WHERE binary(CODE_NM)= #searchData#))
	</select> 
	
	<!-- 사용자 조회 -->
	<select id="TmsProgrmManageDAO.selectUserList" resultClass="TmsLoginVO">
		SELECT EMPLYR_ID
		, ORGNZT_ID
		, USER_NM
		, PASSWORD 
		, ESNTL_ID 
		FROM LETTNEMPLYRINFO
		ORDER BY ESNTL_ID
	</select>
	
	<!-- 공통코드 조회 -->
	<select id="TmsProgrmManageDAO.TmsCommonCodeListSearch" parameterClass="comDefaultVO" resultClass="CommonCodeVO">
		
			SELECT  A.CODE_ID AS "CODE_ID"
			     ,  A.CODE AS "CODE"
			     ,  A.CODE_NM AS "CODE_NM"
			  FROM  LETTCCMMNDETAILCODE A
			     ,  LETTCCMMNCODE       B
			 WHERE 	B.USE_AT  = 'Y' AND binary(A.CODE_NM) like  CONCAT('%', #searchKeyword#, '%')
			   AND  A.CODE_ID = B.CODE_ID
			   LIMIT  #recordCountPerPage# OFFSET #firstIndex#
			   
		
	</select>
	
	<!-- 공통코드수 조회 -->
	<select id="TmsProgrmManageDAO.TmsCommonCodeListSearchTotCnt"  parameterClass="comDefaultVO" resultClass="int">
		
			SELECT  COUNT(*) totcnt 
			  FROM  LETTCCMMNDETAILCODE A
			     ,  LETTCCMMNCODE       B
			 WHERE 	B.USE_AT  = 'Y' AND binary(A.CODE_NM) like  CONCAT('%', #searchKeyword#, '%')
			   AND  A.CODE_ID = B.CODE_ID
	
	</select>
	
	<!-- 프로젝트 생성 -->
	<insert id="TmsProgrmManageDAO.insertProject"  parameterClass="TmsProjectManageVO">
			<![CDATA[
            INSERT INTO PJT_TB
        	(PJT_ID, PJT_NM, PJT_TYPE, PJT_ST, PJT_PM, PJT_PRICE, DEV_START_DT, DEV_END_DT, PJT_START_DT, PJT_END_DT, PJT_CONTENT)
        	VALUES
        	(#PJT_ID#,#PJT_NM#, #PJT_TYPE#, #PJT_ST#, #PJT_PM#, #PJT_PRICE#,#DEV_START_DT#,#DEV_END_DT#,#PJT_START_DT#,#PJT_END_DT#,#PJT_CONTENT#
        	)
			]]>
	</insert>
	
	<!-- 공통코드수 조회 -->
	<select id="TmsProgrmManageDAO.selectTestList" resultClass="java.util.HashMap">
			SELECT  WEEKYEAR
			FROM TEST
	
	</select>
	
	<!-- 공통코드수 조회 -->
	<select id="TmsProgrmManageDAO.selectTestList1" parameterClass="java.lang.Integer" resultClass="java.util.HashMap" remapResults="true">
			SELECT SUM(A#i#) AS week#i# FROM
(
   SELECT IFNULL(X.USER_NM, (SELECT USER_NM FROM LETTNEMPLYRINFO WHERE EMPLYR_ID = Y.USER_DEV_ID)) AS NAME
         ,IFNULL(CASE WHEN X.W = #i# THEN X.CNT END,0) AS A#i#
   FROM
      (
      SELECT C.USER_DEV_ID, D.USER_NM, C.PG, C.PED, C.W, COUNT(C.W) AS CNT FROM
         (SELECT B.USER_DEV_ID, A.PG, A.PED, A.W FROM
            (SELECT PG_ID AS PG
                  ,PLAN_END_DT AS PED
                  ,WEEK(PLAN_END_DT,1) AS W
               FROM DEV_PLAN_TB)AS A
               
            INNER JOIN
            PG_TB B
            ON A.PG = B.PG_ID) AS C
      INNER JOIN
      LETTNEMPLYRINFO D
      ON C.USER_DEV_ID = D.EMPLYR_ID
      GROUP BY C.USER_DEV_ID, C.W
      ) AS X
   
   RIGHT OUTER JOIN
      
      (
      SELECT WEEKYEAR, E.USER_DEV_ID FROM TEST 
      CROSS JOIN (SELECT USER_DEV_ID
                  FROM PG_TB
                  GROUP BY USER_DEV_ID) AS E
      
      ) AS Y
   ON X.W = Y.WEEKYEAR
   AND X.USER_DEV_ID = Y.USER_DEV_ID
   )AS O 
   GROUP BY O.NAME;
	
	</select>

</sqlMap>                            